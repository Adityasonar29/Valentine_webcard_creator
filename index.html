<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Valentine Studio</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{
    --primary:#ff4d6d;
    --accent:#2a9d8f;
    --bg:#fff0f3;
    --panel:#ffffff;
    --text:#590d22;
}
*{box-sizing:border-box;user-select:none;-webkit-user-select:none;margin:0;padding:0;font-family:'Segoe UI',sans-serif}
body{height:100vh;display:flex;background:var(--bg);color:var(--text);overflow:hidden}
button{border:none;border-radius:6px;padding:9px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;background:var(--primary);color:#fff;font-size:.85rem;transition:.2s}
button:hover{filter:brightness(1.08)}
button:active{transform:scale(.97)}
button.sec{background:#ff8fa3}
button.action{background:var(--accent)}
button.sm{font-size:.7rem;padding:6px}
button.outline{background:#fff;border:1px solid #ccc;color:#444}
.row{display:flex;gap:6px;flex-wrap:wrap}
.row>*{flex:1;min-width:60px}
input[type=text],select{width:100%;padding:7px;border:1px solid #ddd;border-radius:4px;font-size:.8rem}
input[type=color]{width:100%;height:32px;border:none}
h1{font-size:1.3rem;color:var(--primary);text-align:center;margin-bottom:6px}
h3{font-size:.75rem;text-transform:uppercase;letter-spacing:1px;opacity:.6;margin:8px 0 4px}
.tabs,.subtabs{display:flex;background:#eee;padding:3px;border-radius:6px}
.tab,.subtab{flex:1;padding:7px;text-align:center;border-radius:4px;font-size:.78rem;font-weight:600;color:#777;cursor:pointer}
.tab.active,.subtab.active{background:#fff;color:var(--primary);box-shadow:0 2px 6px rgba(0,0,0,.1)}
.sticker-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:4px}
.sticker-btn{background:#fafafa;font-size:1.2rem;color:#000;border:none;padding:5px;cursor:pointer}
.sticker-btn:hover{background:#ffe0e8}
.bg-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:4px}
.bg-swatch{width:100%;aspect-ratio:1;border-radius:4px;border:2px solid transparent;cursor:pointer}
.bg-swatch:hover{border-color:var(--accent);transform:scale(1.05)}
#editor-app{display:flex;flex:1}
#sidebar{width:330px;background:var(--panel);padding:15px;display:flex;flex-direction:column;gap:10px;overflow-y:auto;box-shadow:2px 0 15px rgba(0,0,0,.1)}
#workspace{flex:1;background:#444;display:flex;justify-content:center;align-items:center;position:relative;overflow:hidden;background-image:radial-gradient(#555 1px,transparent 1px);background-size:20px 20px}
.canvas{display:none;position:relative;box-shadow:0 15px 45px rgba(0,0,0,.4)}
.canvas.active{display:block}
#front-canvas{width:400px;height:550px;border-radius:0 8px 8px 0;background:linear-gradient(135deg,#ff4d6d,#c9184a)}
#inside-wrapper{width:800px;height:550px;display:none}
#inside-wrapper.active{display:flex}
.inside-page{width:400px;height:550px;position:relative;overflow:hidden;background:#fff}
#left-page{border-radius:8px 0 0 8px;border-right:1px solid rgba(0,0,0,.1)}
#right-page{border-radius:0 8px 8px 0;border-left:1px solid rgba(0,0,0,.1)}
.page-label{position:absolute;bottom:10px;left:50%;transform:translateX(-50%);font-size:.7rem;color:rgba(0,0,0,.25);pointer-events:none}
.element{position:absolute;border:2px solid transparent;min-width:50px;min-height:40px;cursor:grab;box-sizing:border-box}
.element:hover{border-color:rgba(255,255,255,0.4)}
.element.selected{border-color:var(--accent)}
.element img{width:100%;height:100%;object-fit:cover;pointer-events:none;display:block;border-radius:inherit}
.element p{margin:0;width:100%;height:100%;display:flex;justify-content:center;align-items:center;text-align:center;pointer-events:none;white-space:pre-wrap;font-size:24px}
.element.editing p{pointer-events:auto;outline:2px dashed var(--primary);cursor:text;user-select:text;-webkit-user-select:text}
.shape-body{width:100%;height:100%;background:linear-gradient(135deg,#ff9a9e,#fad0c4);pointer-events:none;border-radius:12px}
.handles{display:none}
.element.selected .handles{display:block}
.resize-handle{position:absolute;width:14px;height:14px;background:#fff;border:2px solid var(--accent);border-radius:3px;bottom:-8px;right:-8px;cursor:se-resize;z-index:10}
.rotate-handle{position:absolute;width:22px;height:22px;background:#fff;border:2px solid var(--primary);border-radius:50%;top:-38px;left:50%;transform:translateX(-50%);display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--primary);cursor:grab;z-index:10}
.rotate-handle:before{content:"";position:absolute;width:2px;height:18px;background:var(--primary);top:20px}
#crop-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);z-index:999;display:none;cursor:crosshair}
#editor-preview,#viewer-app{background:#111;position:fixed;top:0;left:0;width:100%;height:100%;display:none;justify-content:center;align-items:center;flex-direction:column;perspective:1800px;z-index:120}
#viewer-app{position:relative; overflow: hidden;}
#editor-preview.active,#viewer-app.active{display:flex}
.book-3d{width:400px;height:550px;transform-style:preserve-3d;transition:transform 2s ease;transform:rotateY(-5deg) rotateX(5deg)}
.book-3d.opened{transform:translateX(200px) rotateY(0deg) rotateX(0deg)}
#viewer-book {
    transition: transform 2.2s ease;
    transform: rotateY(-10deg);
    transform-origin: center; /* Ensures it rotates from the middle */
}

/* This adds the 200px shift to the ID specifically */
#viewer-book.opened {
    transform: translateX(200px) rotateY(0deg);
}
.leaf{position:absolute;width:100%;height:100%;transform-origin:left;transform-style:preserve-3d;transition:transform 2s ease;z-index:10}
.book-3d.opened .leaf{transform:rotateY(-180deg)}
.face{position:absolute;width:100%;height:100%;backface-visibility:hidden;overflow:hidden;border-radius:0 6px 6px 0}
.face.back{transform:rotateY(180deg);border-radius:6px 0 0 6px}
.fixed-page{position:absolute;width:100%;height:100%;border-radius:0 6px 6px 0;overflow:hidden}
.preview-clone{position:absolute;width:100%;height:100%;top:0;left:0;pointer-events:none;background:transparent!important}
.preview-clone .handles{display:none!important}
.preview-clone .element{border-color:transparent!important}
#props{background:#f0f8ff;padding:12px;border-radius:10px;display:none}
.size-display{text-align:center;font-weight:700;background:#fff;padding:4px;border-radius:4px;margin-bottom:5px}
.font-row{display:flex;gap:5px;margin-top:5px}
.font-row select{flex:1}
.info-text{color:#777;margin-top:25px;font-size:.85rem;pointer-events:none}
.warning{font-size:.65rem;color:#666;line-height:1.2}
#editor-app.hidden{display:none}
#rec-indicator{display:none;color:#ff4444;font-weight:bold;animation:blink 1s infinite}
@keyframes blink{50%{opacity:.5}}
@media(max-width:900px){
    #editor-app{flex-direction:column-reverse}
    #sidebar{width:100%;height:240px;flex-direction:row;flex-wrap:nowrap;overflow-x:auto}
    #front-canvas,#inside-wrapper{transform:scale(.55);transform-origin:center top}
}
@media(max-width:600px){
    /* Scale the book down so it fits mobile screens */
    .book-3d {
        transform: scale(0.6) rotateY(-5deg) !important;
    }
    
    /* On mobile, we often don't want a massive shift. 
       A smaller shift (like 100px) keeps it centered. */
    #preview-book.opened, #viewer-book.opened {
        transform: scale(0.6) translateX(100px) rotateY(0deg) !important;
    }
}
</style>
</head>
<body>

<div id="editor-app">
    <div id="sidebar">
        <h1>üíù Valentine Studio</h1>
        
        <div class="tabs">
            <div class="tab active" id="tab-front" onclick="switchView('front')">Front</div>
            <div class="tab" id="tab-inside" onclick="switchView('inside')">Inside</div>
        </div>
        
        <div id="inside-subtabs" style="display:none">
            <div class="subtabs">
                <div class="subtab active" onclick="selectInsidePage('left')">Left Page</div>
                <div class="subtab" onclick="selectInsidePage('right')">Right Page</div>
            </div>
        </div>

        <div class="row" style="margin-top:10px">
            <button class="action" onclick="copyShareLink()">üîó Copy Link</button>
            <button class="sec" onclick="startRecording()">üé• Record</button>
        </div>
        <p class="warning">Link compression enabled - works with photos too!</p>
        <span id="rec-indicator">‚óè REC</span>

        <div>
            <h3>üòä Stickers</h3>
            <div class="sticker-grid" id="stickers"></div>
        </div>

        <div>
            <h3>‚ûï Add Content</h3>
            <div class="row">
                <button onclick="addText()">üìù Text</button>
                <button onclick="document.getElementById('imgInput').click()">üì∑ Photo</button>
            </div>
            <div class="row" style="margin-top:6px">
                <button class="sec" onclick="addShape('rect')">‚ñ≠ Rect</button>
                <button class="sec" onclick="addShape('circle')">‚ö™ Circle</button>
                <button class="sec" onclick="addShape('pill')">‚¨Ø Pill</button>
            </div>
            <input type="file" id="imgInput" accept="image/*" hidden onchange="addImage(event)">
        </div>

        <div id="bg-section">
            <h3 id="bg-title">Cover Background</h3>
            <input type="text" id="bgUrl" placeholder="Image URL..." onchange="applyBgUrl()">
            <div class="row" style="margin-top:5px">
                <button class="sec sm" onclick="applyBgUrl()">Apply URL</button>
                <button class="sec sm" onclick="document.getElementById('bgFile').click()">Upload</button>
            </div>
            <input type="file" id="bgFile" accept="image/*" hidden onchange="applyBgFile(event)">
            
            <h3 style="margin-top:10px">Background Presets</h3>
            <div class="bg-grid">
                <div class="bg-swatch" style="background:#ffffff" onclick="applyBgColor('#fff')"></div>
                <div class="bg-swatch" style="background:#ff4d6d" onclick="applyBgColor('#ff4d6d')"></div>
                <div class="bg-swatch" style="background:#ffc2d1" onclick="applyBgColor('#ffc2d1')"></div>
                <div class="bg-swatch" style="background:#590d22" onclick="applyBgColor('#590d22')"></div>
                <div class="bg-swatch" style="background:linear-gradient(135deg,#ff758f,#ff4d6d)" onclick="applyBgGrad('linear-gradient(135deg,#ff758f,#ff4d6d)')"></div>
                <div class="bg-swatch" style="background:linear-gradient(135deg,#f093fb,#f5576c)" onclick="applyBgGrad('linear-gradient(135deg,#f093fb,#f5576c)')"></div>
                <div class="bg-swatch" style="background:linear-gradient(135deg,#fad0c4,#ffd1ff)" onclick="applyBgGrad('linear-gradient(135deg,#fad0c4,#ffd1ff)')"></div>
                <div class="bg-swatch" style="background:linear-gradient(135deg,#a8edea,#fed6e3)" onclick="applyBgGrad('linear-gradient(135deg,#a8edea,#fed6e3)')"></div>
                <div class="bg-swatch" style="background:linear-gradient(135deg,#ffecd2,#fcb69f)" onclick="applyBgGrad('linear-gradient(135deg,#ffecd2,#fcb69f)')"></div>
                <div class="bg-swatch" style="background:linear-gradient(135deg,#667eea,#764ba2)" onclick="applyBgGrad('linear-gradient(135deg,#667eea,#764ba2)')"></div>
                <div class="bg-swatch" style="background:linear-gradient(135deg,#f6d365,#fda085)" onclick="applyBgGrad('linear-gradient(135deg,#f6d365,#fda085)')"></div>
                <div class="bg-swatch" style="background:linear-gradient(135deg,#84fab0,#8fd3f4)" onclick="applyBgGrad('linear-gradient(135deg,#84fab0,#8fd3f4)')"></div>
                <div class="bg-swatch" style="background:repeating-linear-gradient(45deg,#fff,#fff 12px,#ffdae0 12px,#ffdae0 24px)" onclick="applyBgGrad('repeating-linear-gradient(45deg,#fff,#fff 12px,#ffdae0 12px,#ffdae0 24px)')"></div>
                <div class="bg-swatch" style="background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%)" onclick="applyBgGrad('linear-gradient(135deg, #ff9a9e 0%, #fecfef 99%, #fecfef 100%)')"></div>
                <div class="bg-swatch" style="background: linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%)" onclick="applyBgGrad('linear-gradient(120deg, #a1c4fd 0%, #c2e9fb 100%)')"></div>
                <div class="bg-swatch" style="background: linear-gradient(to top, #fbc2eb 0%, #a6c1ee 100%)" onclick="applyBgGrad('linear-gradient(to top, #fbc2eb 0%, #a6c1ee 100%)')"></div>
                <div class="bg-swatch" style="background: linear-gradient(to right, #43e97b 0%, #38f9d7 100%)" onclick="applyBgGrad('linear-gradient(to right, #43e97b 0%, #38f9d7 100%)')"></div>
                <div class="bg-swatch" style="background: linear-gradient(to top, #30cfd0 0%, #330867 100%)" onclick="applyBgGrad('linear-gradient(to top, #30cfd0 0%, #330867 100%)')"></div>
                <div class="bg-swatch" style="background: linear-gradient(to right, #b8cbb8 0%, #b8cbb8 0%, #b465da 0%, #cf6cc9 33%, #ee609c 66%, #ee609c 100%)" onclick="applyBgGrad('linear-gradient(to right, #b8cbb8 0%, #b8cbb8 0%, #b465da 0%, #cf6cc9 33%, #ee609c 66%, #ee609c 100%)')"></div>
                <div class="bg-swatch" style="background: linear-gradient(to top, #cfd9df 0%, #e2ebf0 100%)" onclick="applyBgGrad('linear-gradient(to top, #cfd9df 0%, #e2ebf0 100%)')"></div>
                <div class="bg-swatch" style="background: linear-gradient(to top, #fff1eb 0%, #ace0f9 100%);" onclick="applyBgGrad('linear-gradient(to top, #fff1eb 0%, #ace0f9 100%)')"></div>
                <div class="bg-swatch" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%)" onclick="applyBgGrad('linear-gradient(135deg, #667eea 0%, #764ba2 100%)')"></div>
                <div class="bg-swatch" style="background: radial-gradient(circle, #ff8fa3 1px, transparent 1px)" onclick="applyBgGrad('radial-gradient(circle, #ff8fa3 1px, transparent 1px)')"></div>
                <div class="bg-swatch" style="background: repeating-linear-gradient(45deg, #fff, #fff 10px, #ffe0e6 10px, #ffe0e6 20px)" onclick="applyBgGrad('repeating-linear-gradient(45deg, #fff, #fff 10px, #ffe0e6 10px, #ffe0e6 20px)')"></div>
            </div>
        </div>

        <div id="props">
            <h3 style="color:var(--accent)">Edit Selected</h3>
            
            <div id="text-tools">
                <div class="size-display"><span id="sizeVal">24</span>px</div>
                <div class="row">
                    <button class="sec sm" onclick="changeTextSize(-4)">A-</button>
                    <button class="sec sm" onclick="changeTextSize(4)">A+</button>
                </div>
                <div class="font-row">
                    <select id="fontSel" onchange="changeFont(this.value)">
                        <option value="Segoe UI">Segoe UI</option>
                        <option value="Georgia">Georgia</option>
                        <option value="Times New Roman">Times</option>
                        <option value="Comic Sans MS">Comic Sans</option>
                        <option value="Courier New">Courier</option>
                        <option value="Brush Script MT">Brush Script</option>
                        <option value="Impact">Impact</option>
                    </select>
                </div>
                <h3 style="margin-top:8px">Text Color</h3>
                <input type="color" id="textColor" onchange="applyTextColor(this.value)">
            </div>

            <div id="shape-tools" style="display:none">
                <h3>Shape Fill Color</h3>
                <input type="color" id="shapeColor" value="#ff9a9e" onchange="updateShapeColor(this.value)">
                <h3 style="margin-top:8px">Shape Gradient</h3>
                <select onchange="updateShapeGrad(this.value)">
                    <option value="">None (Solid)</option>
                    <option value="linear-gradient(135deg,#ff9a9e,#fad0c4)">Peach</option>
                    <option value="linear-gradient(135deg,#a18cd1,#fbc2eb)">Lavender</option>
                    <option value="linear-gradient(135deg,#84fab0,#8fd3f4)">Mint</option>
                    <option value="linear-gradient(135deg,#f6d365,#fda085)">Sunset</option>
                </select>
                <h3 style="margin-top:8px">Border Radius</h3>
                <div class="row">
                    <button class="outline sm" onclick="setShapeRadius(0)">Square</button>
                    <button class="outline sm" onclick="setShapeRadius(20)">Round</button>
                    <button class="outline sm" onclick="setShapeRadius(999)">Pill</button>
                </div>
            </div>

            <h3 style="margin-top:10px">Crop/Mask</h3>
            <div class="row">
                <button class="outline sm" onclick="applyCrop('none')">None</button>
                <button class="outline sm" onclick="applyCrop('circle')">Circle</button>
                <button class="outline sm" onclick="startLasso()">Lasso</button>
            </div>

            <button style="background:#e63946;margin-top:15px" onclick="deleteSelected()">üóëÔ∏è Delete</button>
        </div>

        <button class="action" style="margin-top:auto" onclick="openPreview()">üé¨ Preview</button>
    </div>

    <div id="workspace">
        <div id="front-canvas" class="canvas active" onclick="deselectAll(event)"></div>
        <div id="inside-wrapper">
            <div id="left-page" class="inside-page" onclick="deselectAll(event)">
                <div class="page-label">Inside Left</div>
            </div>
            <div id="right-page" class="inside-page" onclick="deselectAll(event)">
                <div class="page-label">Inside Right</div>
            </div>
        </div>
        <canvas id="crop-overlay"></canvas>
    </div>

    <div id="editor-preview">
        <div style="position:absolute;top:20px;right:20px;z-index:200">
            <button style="background:#fff;color:#000;width:auto" onclick="closePreview()">‚úñ Close</button>
        </div>
        <div class="book-3d" id="preview-book" onclick="this.classList.toggle('opened')">
            <div class="leaf">
                <div class="face front" id="pv-front"></div>
                <div class="face back" id="pv-left"></div>
            </div>
            <div class="fixed-page" id="pv-right"></div>
        </div>
        <p class="info-text">Tap to open/close</p>
    </div>
</div>

<div id="viewer-app">
    <div class="book-3d" id="viewer-book" onclick="this.classList.toggle('opened')">
        <div class="leaf">
            <div class="face front" id="v-front"></div>
            <div class="face back" id="v-left"></div>
        </div>
        <div class="fixed-page" id="v-right"></div>
    </div>
    <p class="info-text">Tap card to open</p>
</div>

<script>
/* LZ Compression */
const LZ=(()=>{const f=String.fromCharCode;return{compressUri:r=>encodeURIComponent(r.replace(/ /g,"+")),decompressUri:r=>{r=decodeURIComponent(r.replace(/\+/g," "));const e={};let n=256,o=1,t=r.charCodeAt(0),c=f(t),s=c;for(let h=1;h<r.length;h++){const l=r.charCodeAt(h);let a=l<n?e[l]?e[l]:f(l):c+c.charAt(0);s+=a,e[n++]=c+a.charAt(0),c=a}return s}}})();

const stickers=['‚ù§Ô∏è','üíï','üíñ','üíó','üíò','üíù','üíû','üåπ','ü•Ä','üíê','üå∏','üå∫','üß∏','üç´','üíã','üíå','üíç','‚ú®','üéÄ','ü¶ã','üéà','üéá'];
let currentView='front',currentInsidePage='left',selectedEl=null;
let dragData=null,resizeData=null,rotateData=null,lassoCtx,lassoPoints=[];

const frontCanvas=document.getElementById('front-canvas');
const leftCanvas=document.getElementById('left-page');
const rightCanvas=document.getElementById('right-page');

window.addEventListener('load',()=>{
    const params=new URLSearchParams(window.location.search);
    if(params.has('card')){
        document.getElementById('editor-app').classList.add('hidden');
        document.getElementById('viewer-app').classList.add('active');
        loadViewer(params.get('card'));
    }else{
        initEditor();
    }
});

function initEditor(){
    const grid=document.getElementById('stickers');
    stickers.forEach(s=>{
        const btn=document.createElement('button');
        btn.className='sticker-btn';
        btn.textContent=s;
        btn.onclick=()=>addSticker(s);
        grid.appendChild(btn);
    });
    
    // Defaults
    addElement(frontCanvas,'text',{text:'For You',x:90,y:200,w:220,h:100,style:'font-size:48px;color:#fff;font-family:Georgia;text-shadow:2px 4px 10px rgba(0,0,0,0.35)'});
    addElement(rightCanvas,'text',{text:"Happy Valentine's Day!",x:60,y:130,w:280,h:80,style:'font-size:32px;color:#c9184a;font-family:"Comic Sans MS"'});
}

function loadViewer(payload){
    try{
        const data=JSON.parse(LZ.decompressUri(payload));
        renderFace(data.front,document.getElementById('v-front'));
        renderFace(data.left,document.getElementById('v-left'));
        renderFace(data.right,document.getElementById('v-right'));
    }catch(e){alert('Failed to load card');}
}

function renderFace(data,target){
    target.innerHTML='';
    if(!data)return;
    applyBgToTarget(target,data.bg);
    data.elements.forEach(item=>{
        const el=document.createElement('div');
        el.className='element';
        el.style.cssText=item.outerStyle;
        el.style.border='none';
        if(item.type==='shape'){
            const div=document.createElement('div');
            div.className='shape-body';
            div.style.cssText=item.innerStyle;
            el.appendChild(div);
        }else if(item.type==='image'){
            const img=document.createElement('img');
            img.src=item.content;
            if(item.innerStyle)img.style.cssText=item.innerStyle;
            el.appendChild(img);
        }else{
            const p=document.createElement('p');
            p.innerHTML=item.content;
            if(item.innerStyle)p.style.cssText=item.innerStyle;
            el.appendChild(p);
        }
        target.appendChild(el);
    });
}

function getActiveCanvas(){
    return currentView==='front'?frontCanvas:(currentInsidePage==='left'?leftCanvas:rightCanvas);
}

function addElement(canvas,type,opts){
    const el=document.createElement('div');
    el.className='element';
    el.dataset.type=type;
    el.style.left=opts.x+'px';
    el.style.top=opts.y+'px';
    el.style.width=opts.w+'px';
    el.style.height=opts.h+'px';
    
    if(type==='text'||type==='sticker'){
        const p=document.createElement('p');
        p.textContent=opts.text;
        p.style.cssText=opts.style||'';
        el.appendChild(p);
    }else if(type==='image'){
        const img=document.createElement('img');
        img.src=opts.src;
        el.appendChild(img);
    }else if(type==='shape'){
        const div=document.createElement('div');
        div.className='shape-body';
        div.style.borderRadius=opts.radius||'12px';
        div.style.background=opts.grad||'#ff9a9e';
        el.appendChild(div);
    }
    
    const handles=document.createElement('div');
    handles.className='handles';
    
    const rz=document.createElement('div');
    rz.className='resize-handle';
    rz.onmousedown=(e)=>{e.stopPropagation();startResize(e,el);};
    
    const rot=document.createElement('div');
    rot.className='rotate-handle';
    rot.textContent='‚Üª';
    rot.onmousedown=(e)=>{e.stopPropagation();startRotate(e,el);};
    
    handles.appendChild(rz);
    handles.appendChild(rot);
    el.appendChild(handles);
    
    el.onmousedown=(e)=>{
        if(e.target.classList.contains('resize-handle')||e.target.classList.contains('rotate-handle'))return;
        selectElement(el);
        dragData={startX:e.clientX,startY:e.clientY,origX:parseFloat(el.style.left),origY:parseFloat(el.style.top),el:el};
        document.addEventListener('mousemove',onDrag);
        document.addEventListener('mouseup',onDragEnd);
    };
    
    el.ondblclick=(e)=>{
        if(type==='text'||type==='sticker'){
            e.stopPropagation();
            const p=el.querySelector('p');
            p.contentEditable=true;
            el.classList.add('editing');
            p.focus();
            p.onblur=()=>{p.contentEditable=false;el.classList.remove('editing');};
            p.onkeydown=(ev)=>{if(ev.key==='Enter'&&!ev.shiftKey){ev.preventDefault();p.blur();}};
        }
    };
    
    canvas.appendChild(el);
    return el;
}

function onDrag(e){
    if(!dragData)return;
    const dx=e.clientX-dragData.startX;
    const dy=e.clientY-dragData.startY;
    dragData.el.style.left=dragData.origX+dx+'px';
    dragData.el.style.top=dragData.origY+dy+'px';
}
function onDragEnd(){dragData=null;document.removeEventListener('mousemove',onDrag);document.removeEventListener('mouseup',onDragEnd);}

function selectElement(el){
    if(selectedEl)selectedEl.classList.remove('selected');
    selectedEl=el;
    el.classList.add('selected');
    document.getElementById('props').style.display='block';
    
    const isText=el.dataset.type==='text'||el.dataset.type==='sticker';
    const isShape=el.dataset.type==='shape';
    
    document.getElementById('text-tools').style.display=isText?'block':'none';
    document.getElementById('shape-tools').style.display=isShape?'block':'none';
    
    if(isText){
        const p=el.querySelector('p');
        document.getElementById('sizeVal').textContent=Math.round(parseFloat(getComputedStyle(p).fontSize));
        document.getElementById('textColor').value=rgbToHex(getComputedStyle(p).color);
    }else if(isShape){
        const div=el.querySelector('.shape-body');
        const comp=getComputedStyle(div);
        document.getElementById('shapeColor').value=rgbToHex(comp.backgroundColor);
    }
}

function deselectAll(e){
    if(e&&e.target!==e.currentTarget)return;
    if(selectedEl){
        selectedEl.classList.remove('selected');
        const p=selectedEl.querySelector('p');
        if(p)p.contentEditable=false;
    }
    selectedEl=null;
    document.getElementById('props').style.display='none';
}

/* Shape Functions */
function addShape(type){
    const opts={type:'shape',x:100,y:100,w:120,h:120,radius:type==='circle'?999:(type==='pill'?999:0),grad:'linear-gradient(135deg,#ff9a9e,#fad0c4)'};
    const el=addElement(getActiveCanvas(),'shape',opts);
    selectElement(el);
}

function updateShapeColor(color){
    if(!selectedEl||selectedEl.dataset.type!=='shape')return;
    selectedEl.querySelector('.shape-body').style.background=color;
}

function updateShapeGrad(grad){
    if(!selectedEl||selectedEl.dataset.type!=='shape')return;
    if(grad)selectedEl.querySelector('.shape-body').style.background=grad;
}

function setShapeRadius(r){
    if(!selectedEl||selectedEl.dataset.type!=='shape')return;
    selectedEl.querySelector('.shape-body').style.borderRadius=r+'px';
}

/* Text Functions */
function addText(){
    const t=prompt('Enter text:','Love');
    if(!t)return;
    addElement(getActiveCanvas(),'text',{text:t,x:80,y:80,w:200,h:60,style:'font-size:32px;color:#ff4d6d'});
}

function addSticker(s){
    addElement(getActiveCanvas(),'sticker',{text:s,x:80,y:80,w:70,h:70,style:'font-size:48px'});
}

function addImage(e){
    const f=e.target.files[0];
    if(!f)return;
    const r=new FileReader();
    r.onload=ev=>addElement(getActiveCanvas(),'image',{src:ev.target.result,x:50,y:50,w:180,h:180});
    r.readAsDataURL(f);
    e.target.value='';
}

function changeTextSize(delta){
    if(!selectedEl)return;
    const p=selectedEl.querySelector('p');
    const s=Math.max(8,parseFloat(getComputedStyle(p).fontSize)+delta);
    p.style.fontSize=s+'px';
    document.getElementById('sizeVal').textContent=Math.round(s);
}

function changeFont(f){
    if(selectedEl&&selectedEl.querySelector('p'))selectedEl.querySelector('p').style.fontFamily=f;
}

function applyTextColor(c){
    if(selectedEl&&selectedEl.querySelector('p'))selectedEl.querySelector('p').style.color=c;
}

/* Resize & Rotate */
function startResize(e,el){
    selectElement(el);
    resizeData={startX:e.clientX,startY:e.clientY,startW:el.offsetWidth,startH:el.offsetHeight,el:el};
    document.addEventListener('mousemove',onResize);
    document.addEventListener('mouseup',onResizeEnd);
}
function onResize(e){
    if(!resizeData)return;
    const w=resizeData.startW+(e.clientX-resizeData.startX);
    const h=resizeData.startH+(e.clientY-resizeData.startY);
    resizeData.el.style.width=Math.max(30,w)+'px';
    resizeData.el.style.height=Math.max(30,h)+'px';
}
function onResizeEnd(){resizeData=null;document.removeEventListener('mousemove',onResize);document.removeEventListener('mouseup',onResizeEnd);}

function startRotate(e,el){
    selectElement(el);
    const rect=el.getBoundingClientRect();
    const cx=rect.left+rect.width/2,cy=rect.top+rect.height/2;
    const ang=Math.atan2(e.clientY-cy,e.clientX-cx);
    const current=getRotation(el);
    rotateData={startAng:ang,current:current,cx:cx,cy:cy,el:el};
    document.addEventListener('mousemove',onRotate);
    document.addEventListener('mouseup',onRotateEnd);
}
function onRotate(e){
    if(!rotateData)return;
    const ang=Math.atan2(e.clientY-rotateData.cy,e.clientX-rotateData.cx);
    const deg=(rotateData.current+(ang-rotateData.startAng)*180/Math.PI)%360;
    rotateData.el.style.transform=`rotate(${deg}deg)`;
}
function onRotateEnd(){rotateData=null;document.removeEventListener('mousemove',onRotate);document.removeEventListener('mouseup',onRotateEnd);}
function getRotation(el){
    const st=getComputedStyle(el).transform;
    if(st==='none')return 0;
    const m=st.match(/matrix\(([^)]+)\)/);
    if(!m)return 0;
    const v=m[1].split(',').map(parseFloat);
    return Math.atan2(v[1],v[0])*180/Math.PI;
}

/* Crop */
function applyCrop(mode){
    if(!selectedEl)return;
    const n=selectedEl.querySelector('img')||selectedEl.querySelector('p');
    if(!n)return;
    n.style.clipPath=mode==='circle'?'circle(50%)':(mode==='rect'?'inset(15% 5%)':'none');
}

function startLasso(){
    if(!selectedEl)return alert('Select an element first');
    const cv=document.getElementById('crop-overlay');
    cv.style.display='block';
    cv.width=cv.offsetWidth;cv.height=cv.offsetHeight;
    lassoCtx=cv.getContext('2d');
    lassoCtx.strokeStyle='#0f0';lassoCtx.lineWidth=2;
    lassoPoints=[];
    let drawing=false;
    cv.onmousedown=e=>{
        drawing=true;
        lassoPoints=[{x:e.offsetX,y:e.offsetY}];
        lassoCtx.beginPath();lassoCtx.moveTo(e.offsetX,e.offsetY);
        cv.onmousemove=ev=>{
            if(!drawing)return;
            lassoPoints.push({x:ev.offsetX,y:ev.offsetY});
            lassoCtx.lineTo(ev.offsetX,ev.offsetY);lassoCtx.stroke();
        };
    };
    cv.onmouseup=()=>{
        drawing=false;cv.onmousemove=null;cv.style.display='none';
        applyLasso();
    };
}
function applyLasso(){
    if(!selectedEl||lassoPoints.length<3)return;
    const r=selectedEl.getBoundingClientRect();
    const wr=document.getElementById('workspace').getBoundingClientRect();
    let poly='polygon(';
    lassoPoints.forEach((p,i)=>{
        const x=((p.x+wr.left-r.left)/r.width*100).toFixed(1);
        const y=((p.y+wr.top-r.top)/r.height*100).toFixed(1);
        poly+=`${x}% ${y}%${i<lassoPoints.length-1?', ':')'}`;
    });
    const n=selectedEl.querySelector('img')||selectedEl.querySelector('p');
    if(n)n.style.clipPath=poly;
}

function deleteSelected(){if(selectedEl){selectedEl.remove();selectedEl=null;document.getElementById('props').style.display='none';}}

/* Backgrounds */
function applyBgColor(c){
    const cv=getActiveCanvas();
    cv.style.background=c;cv.style.backgroundImage='none';
}
function applyBgGrad(g){
    const cv=getActiveCanvas();
    cv.style.background=g;
}
function applyBgUrl(){
    const u=document.getElementById('bgUrl').value.trim();
    if(u)getActiveCanvas().style.background=`url("${u}") center/cover no-repeat`;
}
function applyBgFile(e){
    const f=e.target.files[0];
    if(!f)return;
    const r=new FileReader();
    r.onload=ev=>getActiveCanvas().style.background=`url("${ev.target.result}") center/cover no-repeat`;
    r.readAsDataURL(f);
    e.target.value='';
}
function applyBgToTarget(target,bg){
    if(!bg)return;
    target.style.background=bg.background||'';
    target.style.backgroundImage=bg.backgroundImage||'';
    target.style.backgroundColor=bg.backgroundColor||'';
    target.style.backgroundSize=bg.backgroundSize||'';
}

/* View Switching */
function switchView(v){
    currentView=v;
    document.getElementById('tab-front').classList.toggle('active',v==='front');
    document.getElementById('tab-inside').classList.toggle('active',v==='inside');
    frontCanvas.classList.toggle('active',v==='front');
    document.getElementById('inside-wrapper').classList.toggle('active',v==='inside');
    document.getElementById('inside-subtabs').style.display=v==='inside'?'block':'none';
    updateBgTitle();
    deselectAll();
}
function selectInsidePage(p){
    currentInsidePage=p;
    document.querySelectorAll('.subtab').forEach((t,i)=>t.classList.toggle('active',(p==='left'&&i===0)||(p==='right'&&i===1)));
    updateBgTitle();
    deselectAll();
}
function updateBgTitle(){
    document.getElementById('bg-title').textContent=currentView==='front'?'Cover Background':(currentInsidePage==='left'?'Left Page BG':'Right Page BG');
}

/* Share & Preview */
function copyShareLink(){
    const payload={
        front:serializeCanvas(frontCanvas),
        left:serializeCanvas(leftCanvas),
        right:serializeCanvas(rightCanvas)
    };
    const compressed=LZ.compressUri(JSON.stringify(payload));
    const url=`${location.origin}${location.pathname}?card=${compressed}`;
    navigator.clipboard.writeText(url).then(()=>alert('Sharable link copied! Anyone can view your card with this link.'));
}

function serializeCanvas(canvas){
    const bg={
        background:canvas.style.background,
        backgroundImage:canvas.style.backgroundImage,
        backgroundColor:canvas.style.backgroundColor,
        backgroundSize:canvas.style.backgroundSize
    };
    const elements=[...canvas.querySelectorAll('.element')].map(el=>{
        const type=el.dataset.type;
        let innerStyle='',content='';
        if(type==='shape'){
            const div=el.querySelector('.shape-body');
            innerStyle=div.getAttribute('style')||'';
            content='';
        }else if(type==='image'){
            const img=el.querySelector('img');
            innerStyle=img.getAttribute('style')||'';
            content=img.src;
        }else{
            const p=el.querySelector('p');
            innerStyle=p.getAttribute('style')||'';
            content=p.innerHTML;
        }
        return{type,outerStyle:el.getAttribute('style'),innerStyle,content};
    });
    return{bg,elements};
}

function openPreview(){
    deselectAll();
    cloneToPreview(frontCanvas,document.getElementById('pv-front'));
    cloneToPreview(leftCanvas,document.getElementById('pv-left'));
    cloneToPreview(rightCanvas,document.getElementById('pv-right'));
    document.getElementById('editor-preview').classList.add('active');
    document.getElementById('preview-book').classList.remove('opened');
}
function closePreview(){document.getElementById('editor-preview').classList.remove('active');}

function cloneToPreview(src,target){
    target.innerHTML='';
    const c=getComputedStyle(src);
    target.style.background=c.background;
    target.style.backgroundImage=c.backgroundImage;
    target.style.backgroundColor=c.backgroundColor;
    target.style.backgroundSize=c.backgroundSize;
    const clone=src.cloneNode(true);
    clone.className='preview-clone';
    clone.querySelectorAll('.page-label').forEach(l=>l.remove());
    target.appendChild(clone);
}

/* Recording */
async function startRecording(){
    if(!confirm('Select "This Tab" when prompted'))return;
    try{
        const stream=await navigator.mediaDevices.getDisplayMedia({video:{displaySurface:'browser'},preferCurrentTab:true,selfBrowserSurface:'include'});
        openPreview();
        const rec=new MediaRecorder(stream,{mimeType:'video/webm'});
        const chunks=[];
        rec.ondataavailable=e=>chunks.push(e.data);
        rec.onstop=()=>{
            const blob=new Blob(chunks,{type:'video/webm'});
            const url=URL.createObjectURL(blob);
            const a=document.createElement('a');
            a.href=url;a.download='valentine-card.webm';a.click();
            URL.revokeObjectURL(url);
            stream.getTracks().forEach(t=>t.stop());
            document.getElementById('rec-indicator').style.display='none';
            closePreview();
        };
        rec.start();
        document.getElementById('rec-indicator').style.display='inline';
        setTimeout(()=>{
            document.getElementById('preview-book').classList.add('opened');
            setTimeout(()=>{
                document.getElementById('preview-book').classList.remove('opened');
                setTimeout(()=>rec.stop(),2500);
            },3500);
        },1000);
    }catch(e){alert('Recording failed or cancelled');}
}

/* Utils */
function rgbToHex(rgb){
    if(!rgb||rgb==='transparent')return'#ffffff';
    const m=rgb.match(/\d+/g);
    if(!m)return'#ffffff';
    return'#'+m.slice(0,3).map(x=>('0'+parseInt(x).toString(16)).slice(-2)).join('');
}

/* Touch */
document.addEventListener('touchstart',e=>{
    const t=e.touches[0];
    const el=document.elementFromPoint(t.clientX,t.clientY);
    if(el)el.dispatchEvent(new MouseEvent('mousedown',{clientX:t.clientX,clientY:t.clientY,bubbles:true}));
},{passive:false});
document.addEventListener('touchmove',e=>{
    const t=e.touches[0];
    document.dispatchEvent(new MouseEvent('mousemove',{clientX:t.clientX,clientY:t.clientY}));
},{passive:false});
document.addEventListener('touchend',()=>document.dispatchEvent(new MouseEvent('mouseup')));
</script>
</body>
</html>
